void InitWmInterface()
{
	DeleteAttribute(&BattleInterface,"");
	WM_InitializeCommands();
	WM_SetParameterData();

	CreateEntity(&BattleInterface,"WM_INTERFACE");
	LayerAddObject("execute",&BattleInterface,-1);
	LayerAddObject("realize",&BattleInterface,-1);

	SetEventHandler("BI_CommandEndChecking","WM_CommandEndChecking",0);
	SetEventHandler("BI_LaunchCommand","WM_LaunchCommand",0);
	SetEventHandler("WM_SetPossibleCommands","WM_SetPossibleCommands",0);
	SetEventHandler("WM_UpdateCurrentAction","WM_UpdateCurrentAction",0);

	CreateILogAndActions(LOG_FOR_WORLDMAP);
	Log_SetActiveAction("EnterToSea");

	SetEventHandler("BI_UpdateWmInterface","BI_UpdateWmInterface",0);
	PostEvent("BI_UpdateWmInterface",1000);
	SetEventHandler("Control Activation","WM_ProcessControlPress",0);
}

void WM_ProcessControlPress()
{
	string ControlName = GetEventData();
	if( sti(InterfaceStates.Launched) != 0 ) {return;}

	switch(ControlName)
	{
		case "BICommandsActivate":
			PlaySound("interface\ok.wav"); // boal даешь звуки!
		break;
	}
}

void BI_UpdateWmInterface()
{
	SendMessage(&BattleInterface,"l",BI_MSG_REFRESH);
	PostEvent("BI_UpdateWmInterface",1000);
}

void DeleteWmInterface()
{
	DeleteClass(&BattleInterface);
	DelEventHandler("BI_CommandEndChecking", "WM_CommandEndChecking");
	DelEventHandler("BI_LaunchCommand", "WM_LaunchCommand");
	DelEventHandler("WM_SetPossibleCommands","WM_SetPossibleCommands");
	DelEventHandler("WM_UpdateCurrentAction","WM_UpdateCurrentAction");
	DelEventHandler("BI_UpdateWmInterface","BI_UpdateWmInterface");
	DelEventHandler("Control Activation","WM_ProcessControlPress");
}

ref WM_CommandEndChecking()
{
	BI_retComValue = 0;
	string comName = GetEventData();

	switch(comName)
	{
	case "cancel":
		BI_retComValue = -1;
		break;
	}
	return &BI_retComValue;
}

void WM_LaunchCommand()
{
	int charIdx = GetEventData();
	string commandName = GetEventData();
	int targetNum = GetEventData();
	string locName = GetEventData();

	ref chRef = GetCharacter(charIdx);
	if( LAi_IsDead(chRef) ) return;

	aref arFader;
	if( FindClass(arFader,"fader") ) {return;}

	if(targetNum==-1 && locName=="cancel") {
		SendMessage(&BattleInterface,"ls",MSG_BATTLE_LAND_MAKE_COMMAND,"cancel");
		return;
	}
	if(commandName=="cancel") {
		SendMessage(&BattleInterface,"ls",MSG_BATTLE_LAND_MAKE_COMMAND,"cancel");
		return;
	}
	switch(commandName)
	{
	case "EnterToSea":
		SendMessage(&worldMap,"l",MSG_WORLDMAP_LAUNCH_EXIT_TO_SEA);
		break;
	case "EnterToIsland":
		SendMessage(&worldMap,"l",MSG_WORLDMAP_LAUNCH_EXIT_TO_SEA);
		break;
	case "EnterToShip":
		SendMessage(&worldMap,"l",MSG_WORLDMAP_LAUNCH_EXIT_TO_SEA);
		break;
	case "EnterToStorm":
		SendMessage(&worldMap,"l",MSG_WORLDMAP_LAUNCH_EXIT_TO_SEA);
		break;
	case "EnterToAttack":
		SendMessage(&worldMap,"l",MSG_WORLDMAP_LAUNCH_EXIT_TO_SEA);
		break;
	case "EnterToEnemy":
		SendMessage(&worldMap,"l",MSG_WORLDMAP_LAUNCH_EXIT_TO_SEA);
		break;
	}
	BI_SetSpecCommandMode(BI_COMMODE_MY_SHIP_SELECT,-1,-1,-1, 0);
}

void WM_SetPossibleCommands()
{
	int chIdx = GetEventData();
	int mainIdx = sti(pchar.index);

	if( chIdx<0 || CharacterIsDead(GetCharacter(chIdx)) )
	{
		// отключим все команды
		aref aroot,arcur;
		makearef(aroot,BattleInterface.Commands);
		int q = GetAttributesNum(aroot);
		for(int i=0; i<q; i++)
		{
			arcur = GetAttributeN(aroot,i);
			arcur.enable = false;
		}
		return;
	}
	BattleInterface.Commands.Cancel.enable = true;
	BattleInterface.Commands.EnterToAttack.enable = false;
	BattleInterface.Commands.EnterToShip.enable	= false;
	BattleInterface.Commands.EnterToSea.enable = false;
	BattleInterface.Commands.EnterToIsland.enable = false;
	BattleInterface.Commands.EnterToStorm.enable = false;
	BattleInterface.Commands.EnterToEnemy.enable = false;

	bool bDefault = true;
	switch( sti(worldMap.encounter_type) )
	{
	case 0:
		BattleInterface.Commands.EnterToIsland.enable = true;
		//Log_SetActiveAction("EnterToIsland");
		Log_SetActiveAction("EnterToSea");
		bDefault = false;
		break;
	case 1:
		BattleInterface.Commands.EnterToShip.enable	= true;
		Log_SetActiveAction("EnterToShip");
		bDefault = false;
		break;
	case 2:
		BattleInterface.Commands.EnterToAttack.enable = true;
		Log_SetActiveAction("EnterToAttack");
		bDefault = false;
		break;
	case 3:
		BattleInterface.Commands.EnterToEnemy.enable = true;
		Log_SetActiveAction("EnterToEnemy");
		bDefault = false;
		break;
	case 4:
		BattleInterface.Commands.EnterToStorm.enable = true;
		Log_SetActiveAction("EnterToStorm");
		bDefault = false;
		break;
	}
	if( bDefault )
	{
		if( sti(worldMap.encounter_island) ) {
			BattleInterface.Commands.EnterToIsland.enable = true;
			//Log_SetActiveAction("EnterToIsland");
			Log_SetActiveAction("EnterToSea");
		} else {
			BattleInterface.Commands.EnterToSea.enable = true;
			Log_SetActiveAction("EnterToSea");
		}
	}
}

void WM_UpdateCurrentAction()
{
	bool bDefault = true;
	switch( sti(worldMap.encounter_type) )
	{
	case 0:
		//Log_SetActiveAction("EnterToIsland");
		Log_SetActiveAction("EnterToSea");
		bDefault = false;
		break;
	case 1:
		Log_SetActiveAction("EnterToShip");
		bDefault = false;
		break;
	case 2:
		Log_SetActiveAction("EnterToAttack");
		bDefault = false;
		break;
	case 3:
		Log_SetActiveAction("EnterToEnemy");
		bDefault = false;
		break;
	case 4:
		Log_SetActiveAction("EnterToStorm");
		bDefault = false;
		break;
	}
	if( bDefault ) {
		if( sti(worldMap.encounter_island) ) {
			//Log_SetActiveAction("EnterToIsland");
			Log_SetActiveAction("EnterToSea");
		} else {
			Log_SetActiveAction("EnterToSea");
		}
	}
	SendMessage(&BattleInterface,"l",BI_MSG_REFRESH);
}

void WM_InitializeCommands()
{
	int idLngFile = LanguageOpenFile("commands_name.txt");

	BattleInterface.Commands.Cancel.enable			= false;
	BattleInterface.Commands.Cancel.picNum			= 1;
	BattleInterface.Commands.Cancel.selPicNum		= 0;
	BattleInterface.Commands.Cancel.texNum			= 0;
	BattleInterface.Commands.Cancel.event			= "Cancel";
	BattleInterface.Commands.Cancel.note			= LanguageConvertString(idLngFile, "sea_Cancel");

	BattleInterface.Commands.EnterToSea.enable		= false;
 	BattleInterface.Commands.EnterToSea.picNum		= 1;
	BattleInterface.Commands.EnterToSea.selPicNum	= 9;
	BattleInterface.Commands.EnterToSea.texNum		= 1;
	BattleInterface.Commands.EnterToSea.event		= "EnterToSea";
	BattleInterface.Commands.EnterToSea.note		= LanguageConvertString(idLngFile, "worldmap_sea");

	BattleInterface.Commands.EnterToIsland.enable		= false;
	BattleInterface.Commands.EnterToIsland.picNum		= 1;//0;
	BattleInterface.Commands.EnterToIsland.selPicNum	= 9;//8;
	BattleInterface.Commands.EnterToIsland.texNum		= 1;
	BattleInterface.Commands.EnterToIsland.event		= "EnterToIsland";
	BattleInterface.Commands.EnterToIsland.note			= LanguageConvertString(idLngFile, "worldmap_sea");

	BattleInterface.Commands.EnterToShip.enable		= false;
	BattleInterface.Commands.EnterToShip.picNum		= 4;
	BattleInterface.Commands.EnterToShip.selPicNum	= 12;
	BattleInterface.Commands.EnterToShip.texNum		= 1;
	BattleInterface.Commands.EnterToShip.event		= "EnterToShip";
	BattleInterface.Commands.EnterToShip.note		= LanguageConvertString(idLngFile, "worldmap_sea");

	BattleInterface.Commands.EnterToStorm.enable		= false;
	BattleInterface.Commands.EnterToStorm.picNum		= 5;
	BattleInterface.Commands.EnterToStorm.selPicNum		= 13;
	BattleInterface.Commands.EnterToStorm.texNum		= 1;
	BattleInterface.Commands.EnterToStorm.event			= "EnterToStorm";
	BattleInterface.Commands.EnterToStorm.note			= LanguageConvertString(idLngFile, "worldmap_sea");

	BattleInterface.Commands.EnterToAttack.enable		= false;
	BattleInterface.Commands.EnterToAttack.picNum		= 2;
	BattleInterface.Commands.EnterToAttack.selPicNum	= 10;
	BattleInterface.Commands.EnterToAttack.texNum		= 1;
	BattleInterface.Commands.EnterToAttack.event		= "EnterToAttack";
	BattleInterface.Commands.EnterToAttack.note			= LanguageConvertString(idLngFile, "worldmap_sea");

	BattleInterface.Commands.EnterToEnemy.enable	= false;
	BattleInterface.Commands.EnterToEnemy.picNum	= 3;
	BattleInterface.Commands.EnterToEnemy.selPicNum	= 11;
	BattleInterface.Commands.EnterToEnemy.texNum	= 1;
	BattleInterface.Commands.EnterToEnemy.event		= "EnterToEnemy";
	BattleInterface.Commands.EnterToEnemy.note		= LanguageConvertString(idLngFile, "worldmap_sea");

	LanguageCloseFile(idLngFile);

	worldMap.encounter_type = -1;
}

void WM_SetParameterData()
{
    //#20180714-01
    float fHtRatio = stf(Render.screen_y) / BI_COMPARE_HEIGHT;
    int fTmp, fTmp2;
	BattleInterface.CommandTextures.list.t0.name = "battle_interface\cancel.tga";
	BattleInterface.CommandTextures.list.t0.xsize = 2;
	BattleInterface.CommandTextures.list.t0.ysize = 1;

	BattleInterface.CommandTextures.list.t1.name = "battle_interface\worldmapcommands.tga";
	BattleInterface.CommandTextures.list.t1.xsize = 8;
	BattleInterface.CommandTextures.list.t1.ysize = 2;

	BattleInterface.wm_sign.fontid			= "interface_normal";
	BattleInterface.wm_sign.fontcolor		= argb(255,255,255,255);
	//#20180714-01
	//if(fHtRatio < BI_MIN_RES || fHtRatio > BI_MAX_RES) {
        // BattleInterface.wm_sign.fontscale		= 1.1 * fHtRatio;
        // fTmp = makeint(-14.0 * fHtRatio);
        // fTmp2 = makeint(18.0 * fHtRatio);
        // BattleInterface.wm_sign.fontoffset       = fTmp + "," + fTmp2;
	//}
    //else {
       BattleInterface.wm_sign.fontscale		= 1.5;
	//}

	BattleInterface.wm_sign.shipnamefontid			= "interface_normal"; // ÷вет количества матросов + цвет имени корабл€
	BattleInterface.wm_sign.shipnamefontcolor		= argb(255,255,255,255);

	//#20180714-01
	//if(fHtRatio < BI_MIN_RES || fHtRatio > BI_MAX_RES) {
        // BattleInterface.wm_sign.shipnamefontscale		= 1.1 * fHtRatio;
        // fTmp = makeint(-14.0 * fHtRatio);
        // fTmp2 = makeint(40.0 * fHtRatio);
        // BattleInterface.wm_sign.shipnamefontoffset       = fTmp + "," + fTmp2;
	//}
    //else {
       BattleInterface.wm_sign.shipnamefontscale		= 1.1;
	//}

	BattleInterface.wm_sign.backtexturename		= "battle_interface\ShipBackIcon_WM.tga.tx";
	BattleInterface.wm_sign.backcolor				= argb(255,128,128,128);
	BattleInterface.wm_sign.backuv					= "0.0,0.0,1.0,1.0";
	BattleInterface.wm_sign.backoffset				= "-1,-2";
	//#20180714-01
	//if(fHtRatio < BI_MIN_RES || fHtRatio > BI_MAX_RES) {
        // fTmp = makeint(128.0 * fHtRatio);
        // BattleInterface.wm_sign.backiconsize			= fTmp + "," + fTmp;
	//}
    //else {
       BattleInterface.wm_sign.backiconsize			= "128,128";
    //}

	BattleInterface.wm_sign.shipstatetexturename	= "battle_interface\ShipState.tga.tx";
	BattleInterface.wm_sign.shipstatecolor			= argb(255,128,128,128);
	BattleInterface.wm_sign.shiphpuv				= "0.0,0.109,0.5,0.6875";
	BattleInterface.wm_sign.shiphpoffset			= "-32,-13";
	BattleInterface.wm_sign.shiphpiconsize			= "64,74";
	BattleInterface.wm_sign.shipspuv				= "0.5,0.109,1.0,0.6875";
	//#20180714-01
	//if(fHtRatio < BI_MIN_RES || fHtRatio > BI_MAX_RES) {
        // fTmp = makeint(-32.0 * fHtRatio);
        // fTmp2 = makeint(-13.0 * fHtRatio);
        // BattleInterface.wm_sign.shiphpoffset			= fTmp + "," + fTmp2;
        // fTmp = makeint(32.0 * fHtRatio);
        // BattleInterface.wm_sign.shipspoffset			= fTmp + "," + fTmp2;
        // fTmp = makeint(64.0 * fHtRatio);
        // fTmp2 = makeint(74.0 * fHtRatio);
        // BattleInterface.wm_sign.shiphpiconsize			= fTmp + "," + fTmp2;
        // BattleInterface.wm_sign.shipspiconsize			= fTmp + "," + fTmp2;
	//}
	//else {
       BattleInterface.wm_sign.shiphpoffset			= "-32,-13";
       BattleInterface.wm_sign.shiphpiconsize			= "64,74";
       BattleInterface.wm_sign.shipspoffset			= "33,-13";
       BattleInterface.wm_sign.shipspiconsize			= "64,74";
	//}

	BattleInterface.wm_sign.shipclasstexturename	= "battle_interface\ShipClass.tga.tx";
	BattleInterface.wm_sign.shipclasscolor			= argb(255,128,128,128);
	BattleInterface.wm_sign.shipclassuv			= "0.0,0.0,1.0,1.0";
	//#20180714-01
	//if(fHtRatio < BI_MIN_RES || fHtRatio > BI_MAX_RES) {
        // fTmp = makeint(-14.0 * fHtRatio);
        // fTmp2 = makeint(-50.0 * fHtRatio);
        // BattleInterface.wm_sign.shipclassoffset		= fTmp + "," + fTmp2;
        // fTmp = makeint(64.0 * fHtRatio);
        // fTmp2 = makeint(16.0 * fHtRatio);
        // BattleInterface.wm_sign.shipclassiconsize		= fTmp + "," + fTmp2;
	//}
	//else {
       BattleInterface.wm_sign.shipclassoffset		= "-12,-53";
       BattleInterface.wm_sign.shipclassiconsize		= "64,16";
	//}
	BattleInterface.wm_sign.gunchargeprogress		= "0.0625, 0.219, 0.359, 0.5, 0.641, 0.781, 0.983";

	BattleInterface.wm_sign.shiptexturename		= "battle_interface\ship_icons2.tga.tx";
	BattleInterface.wm_sign.shipcolor				= argb(255,128,128,128);
	BattleInterface.wm_sign.shipoffset				= "-12,-15";
	BattleInterface.wm_sign.shipiconsize			= "64,64";

	//#20180714-01
	//if(fHtRatio < BI_MIN_RES || fHtRatio > BI_MAX_RES) {
        // fTmp = makeint(-14.0 * fHtRatio);
        // fTmp2 = makeint(-12.0 * fHtRatio);
        // BattleInterface.wm_sign.shipoffset				= fTmp + "," + fTmp2;
        // fTmp = makeint(64.0 * fHtRatio);
        // BattleInterface.wm_sign.shipiconsize			= fTmp + "," + fTmp;
        // fTmp = makeint(-40.0 * fHtRatio);
        // BattleInterface.wm_sign.commandlistverticaloffset = fTmp;
        // float fTmp3;
        // fTmp = makeint(70.0 * fHtRatio);
        // fTmp3 = fTmp;
        // fTmp2 = makeint(128.0 * fHtRatio);
        // BattleInterface.wm_sign.iconoffset1 = fTmp + "," + fTmp;
        // fTmp3 += fTmp2;
        // BattleInterface.wm_sign.iconoffset2 = fTmp + "," + fTmp3;
        // fTmp3 += fTmp2;
        // BattleInterface.wm_sign.iconoffset3 = fTmp + "," + fTmp3;
        // fTmp3 += fTmp2;
        // BattleInterface.wm_sign.iconoffset4 = fTmp + "," + fTmp3;
        // fTmp3 += fTmp2;
        // BattleInterface.wm_sign.iconoffset5 = fTmp + "," + fTmp3;
	//}
	//else {
       BattleInterface.wm_sign.shipoffset				= "-14,-12";
       BattleInterface.wm_sign.shipiconsize			= "64,64";

       BattleInterface.wm_sign.commandlistverticaloffset = -40;

       BattleInterface.wm_sign.iconoffset1 = "70,70";
       BattleInterface.wm_sign.iconoffset2 = "70,198";
       BattleInterface.wm_sign.iconoffset3 = "70,326";
       BattleInterface.wm_sign.iconoffset4 = "70,454";
       BattleInterface.wm_sign.iconoffset5 = "70,582";
       BattleInterface.wm_sign.iconoffset6 = "70,710"; //Saint-Ashley - Added icons for companion ships 6-8
       BattleInterface.wm_sign.iconoffset7 = "70,838";
       BattleInterface.wm_sign.iconoffset8 = "70,966";
	//}

	BattleInterface.CommandList.CommandMaxIconQuantity = 8;
	BattleInterface.CommandList.CommandIconSpace = 1;
	BattleInterface.CommandList.CommandIconLeft = makeint(108 * fHtRatio);//157;
	BattleInterface.CommandList.CommandIconWidth = RecalculateHIcon(makeint(48 * fHtRatio));
	BattleInterface.CommandList.CommandIconHeight = RecalculateVIcon(makeint(48 * fHtRatio));

	BattleInterface.CommandList.CommandNoteFont = "interface_button";
	BattleInterface.CommandList.CommandNoteColor = argb(255,255,255,255);
	BattleInterface.CommandList.CommandNoteScale = 1.5 * fHtRatio;
	BattleInterface.CommandList.CommandNoteOffset = RecalculateHIcon(0) + "," + RecalculateVIcon(makeint(-42 * fHtRatio));

	BattleInterface.CommandList.CommandNoteFont = "interface_button";
	BattleInterface.CommandList.CommandNoteColor = argb(255,255,255,255);
	BattleInterface.CommandList.CommandNoteScale = 1.5 * fHtRatio;
	BattleInterface.CommandList.CommandNoteOffset = RecalculateHIcon(0) + "," + RecalculateVIcon(makeint(-42 * fHtRatio));

	BattleInterface.CommandList.UDArrow_Texture = "battle_interface\arrowly.tga.tx";
	BattleInterface.CommandList.UDArrow_UV_Up = "0.0,1.0,1.0,0.0";
	BattleInterface.CommandList.UDArrow_UV_Down = "0.0,0.0,1.0,1.0";
	BattleInterface.CommandList.UDArrow_Size = RecalculateHIcon(makeint(32 * fHtRatio)) + "," + RecalculateVIcon(makeint(32 * fHtRatio));
	BattleInterface.CommandList.UDArrow_Offset_Up = RecalculateHIcon(makeint(-41 * fHtRatio)) + "," + RecalculateVIcon(makeint(-30 * fHtRatio));
	BattleInterface.CommandList.UDArrow_Offset_Down = RecalculateHIcon(makeint(-41 * fHtRatio)) + "," + RecalculateVIcon(makeint(46 * fHtRatio));

	/*BattleInterface.CommandList.ActiveIcon_Texture = "battle_interface\enter_list.tga.tx";
	BattleInterface.CommandList.ActiveIcon_Offset = RecalculateHIcon(-49) + ",0";
	BattleInterface.CommandList.ActiveIcon_Size = RecalculateHIcon(48) + "," + RecalculateVIcon(48);
	BattleInterface.CommandList.ActiveIcon_UV1 = "0.5,0.0,1.0,1.0";
	BattleInterface.CommandList.ActiveIcon_UV2 = "0.0,0.0,0.5,1.0";
	BattleInterface.CommandList.ActiveIcon_Note = XI_ConvertString("MenuNote"); */

	BattleInterface.maincharindex = pchar.index;

	WM_SetShipData();
}

void WM_SetShipData()
{
	int i,n,cn;
	string signattr;
	float uvleft,uvtop, uvright,uvbottom;

	i = 1;
	for(n=0; n<COMPANION_MAX; n++)
	{
		cn = GetCompanionIndex(pchar,n);
		if( cn!=-1 )
		{
			signattr = "sign" + i;
			BattleInterface.wm_sign.(signattr).leftprogress = GetHullPercent(&Characters[cn]) * 0.01;
			BattleInterface.wm_sign.(signattr).rightprogress = GetSailPercent(&Characters[cn]) * 0.01;
			BattleInterface.wm_sign.(signattr).starprogress = GetStarProgressByValue( GetCharacterShipClass(&Characters[cn]) );
			GetTextureUVForShip( sti(RealShips[sti(characters[cn].Ship.Type)].basetype), &uvleft,&uvtop, &uvright,&uvbottom);
			BattleInterface.wm_sign.(signattr).faceuv = uvleft+","+uvtop + "," + uvright+","+uvbottom;
			BattleInterface.wm_sign.(signattr).text = GetCrewQuantity(&Characters[cn]);
			i++;
		}
	}
}

float GetStarProgressByValue(int n)
{
	float f = 0.0;
	switch( n )
	{
	case 1: f = 0.219; break;
	case 2: f = 0.359; break;
	case 3: f = 0.5; break;
	case 4: f = 0.641; break;
	case 5: f = 0.781; break;
	case 6: f = 0.983; break;
	}
	return f;
}
